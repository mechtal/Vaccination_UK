---
output:
  bookdown::pdf_document2:
    fig_caption: yes
    latex_engine: xelatex
header-includes:
   - \usepackage{floatrow}
   - \floatsetup[figure]{capposition=top}
classoption: landscape
---
## Model for England {#model_england}

```{r, include=FALSE}
#---------------------------------------
# knitr -- create pretty tables for a presentation
#---------------------------------------
if(!require(knitr)){install.packages("knitr")}
library(knitr)
#---------------------------------------
# kableExtra -- create pretty tables for a presentation
#---------------------------------------
if(!require(kableExtra)){install.packages("kableExtra")}
library(kableExtra)
#---------------------------------------
# dplyr -- rename
#---------------------------------------
if(!require(dplyr)){install.packages("dplyr")}
library(dplyr)
#---------------------------------------
# tidyr -- replace_na
#---------------------------------------
if(!require(tidyr)){install.packages("tidyr")}
library(tidyr)
#---------------------------------------
# forecast -- forcasting
#---------------------------------------
if(!require(forecast)){install.packages("forecast")}
library(forecast)
#---------------------------------------
# ggplot2 -- plots
#---------------------------------------
if(!require(ggplot2)){install.packages("ggplot2")}
library(ggplot2)
```

Look at the dataset.
```{r, echo=FALSE}
england <- read.csv("/Users/travel_mechtal/Documents/UWE/Portfolio/nation_2022-03-10.csv", header = TRUE, sep = ",")

england$Date <- as.Date(england$date, format = "%Y-%m-%d")

england <- england[order(england$Date),]

england = rename(england, 
       First = newPeopleVaccinatedFirstDoseByVaccinationDate
       ,Second = newPeopleVaccinatedSecondDoseByVaccinationDate
       ,Third = newPeopleVaccinatedThirdInjectionByVaccinationDate
         )

england <- england[c("Date", "First", "Second", "Third")]

england$Third <- england$Third %>% replace_na(0)

kable(head(england))
```
```{r, include=FALSE}
FitColumn <- "First"
```

```{r england_plot, echo=FALSE}
ggplot(england, aes_string(x="Date", y=FitColumn)) +
  geom_line() +
  scale_y_continuous(labels = scales::comma)
```

What can we say?

There is a not stationary time series, as the series wanders up and down for long periods.

```{r england_fit, include=FALSE}
englandFit <- ts(data=england[FitColumn], frequency = 1)
autoplot(englandFit)
```

```{r fit, include=FALSE}
fit <- auto.arima(englandFit)
```

```{r fit_summary, echo=FALSE}
summary(fit)
```
ARIMA(5, 1, 3)
ARIMA(p,d,q)

* p - is the order of Auto-regressive or linear model
* q â€“ is the order of Moving Average/ number of lagged values
* d- difference value to make the time series stationary from non-stationary.
If the data is stationary, then d=0. So, I was right earlier.

```{r, echo=FALSE}
acf(englandFit)
```

As we know, the autocorrelation function (ACF) assesses the correlation between observations in a time series for a set of lags. In an ACF plot, each bar represents the size and direction of the correlation. Bars that extend across the blue line are statistically significant.

So, 

* this ACF plot indicates that these time series data are not random.
* the autocorrelations decline slowly.
* When a time series has both a trend and seasonality, the ACF plot displays a mixture of both effects. Notice how you can see the wavy correlations for the seasonal pattern and the slowly diminishing lags of a trend.

```{r, include=FALSE}
pacf(englandFit)
#The first difference is really important
#The partial autocorrelation function is similar to the ACF except that it displays only the correlation between two observations that the shorter lags between those observations do not explain. 
```

The residuals in ARIMA models tell a story about the performance of your model and should be taken into consideration when evaluating them. The functions checkresiduals, ACF and PACF make it easy to keep track of the information left behind in the residuals by your model. <https://towardsdatascience.com/time-series-analysis-with-auto-arima-in-r-2b220b20e8ab>

```{r fit_residuals, echo=FALSE}
checkresiduals(fit)
```

```{r, include=FALSE}
acf(fit$residuals)
pacf(fit$residuals)
autoplot(fit$residuals)
#well behaved (?), constant variance over time
mean(fit$residuals)
```

```{r fit_forecast_plot, echo=FALSE}
autoplot(forecast(fit))
```

```{r}
forecast(fit)$lower
```

```{r}
forecast(fit)$upper[1,]
```

```{r, include=FALSE}
log(englandFit)[1,0]
autoplot(log(englandFit))
fit2 <- auto.arima(log(englandFit))
checkresiduals(fit2)
#look any better (?)
#smooth out (?)
#capture seasonality (?)
```

```{r, include=FALSE}
FitColumn <- "Second"
<<england_plot>>
<<england_fit>>
<<fit>>
<<fit_summary>>
<<fit_residuals>>
<<fit_forecast_plot>>
```

```{r, include=FALSE}
FitColumn <- "Third"
<<england_plot>>
<<england_fit>>
<<fit>>
<<fit_summary>>
<<fit_residuals>>
<<fit_forecast_plot>>
```