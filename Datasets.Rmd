---
output:
  bookdown::pdf_document2:
    fig_caption: yes
    latex_engine: xelatex
header-includes:
   - \usepackage{floatrow}
   - \floatsetup[figure]{capposition=top}
classoption: landscape
---
# Choosing datasets

```{r DatasetsPaths, include=FALSE}
path = "/Users/travel_mechtal/Documents/UWE/Portfolio/"
```

```{r DatasetsLibraries, include=FALSE}
#---------------------------------------
# Knitting to pdf
#---------------------------------------
if(!require(tinytex)){install.packages("tinytex")}
library(tinytex)
#---------------------------------------
# Creating pretty tables
#---------------------------------------
if(!require(knitr)){install.packages("knitr")}
library(knitr)
#---------------------------------------
if(!require(kableExtra)){install.packages("kableExtra")}
library(kableExtra)
#---------------------------------------
# Working with objects
#---------------------------------------
# json
if(!require(jsonlite)){install.packages("jsonlite")}
library(jsonlite)
#---------------------------------------
# hash
if(!require(hash)){install.packages("hash")}
library(hash)
#---------------------------------------
# %>%
if(!require(tidyverse)){install.packages("tidyverse")}
library(tidyverse)
```

```{r DatasetsRFunctions, include=FALSE}
#---------------------------------------
# My function for a list view
#---------------------------------------
source("my_kable.R")
#---------------------------------------
# My function to show which metrics belong to the dataset
#---------------------------------------
source("show_links.R")
```

* Create a list of metrics for each dataset

```{r DatasetsVariables, include=FALSE}
# create dictionary: short area type's name = area type's name
AreaTypesDict <- hash("ltla"="Lower Tier Local Authority (LTLA)"
                      ,"msoa"="Middle-layer Super Output Area (MSOA)"
                      ,"nation"="Nation"
                      ,"nhsRegion"="NHS Region"
                      ,"nhsTrust"="NHS Trust"
                      ,"overview"="Overview"
                      ,"region"="Region"
                      ,"utla"="Upper Tier Local Authority (UTLA)"
                      )
# create vectors that are named as keys from AreaTypesDict and contain the dataset's metrics
for(AreaType in keys(AreaTypesDict)){
  # AreaType metrics' file path
  full_path = paste(path, "metrics_", AreaType, ".json", sep="")
  # create vector with metrics and name it as AreaType's value
  assign(AreaType, 
           subset(
           # transform to dataframe json file
           as.data.frame(read_json(full_path, simplifyVector = TRUE)),
           # conditions for subset
           category == "Vaccinations" & startsWith(metric_name, "New"))[,c("metric_name")]
         )
}
```

* Look at the metrics
```{r DatasetsAreaTypeExample1, include=FALSE}
AreaTypeExample <- "ltla"
```

```{r DatasetsAreaTypeExample, echo=FALSE}
my_kable(get(AreaTypeExample), AreaTypesDict[[AreaTypeExample]])
```

```{r DatasetsAreaTypeExample2, echo=FALSE}
AreaTypeExample <- "nation"
<<DatasetsAreaTypeExample>>
```

So, as we can see, **some metrics are common**.
I suggest finding out which metrics are the same for all datasets.

* Add new metrics in a common list

```{r DatasetsNewMetricsVariables, include=FALSE}
Metrics = c()

for(AreaType in keys(AreaTypesDict)) {
  # combine two vectors and keep it as Metrics
  Metrics = c(Metrics,get(AreaType))
}
UniqMetrics = unique(Metrics)

first = UniqMetrics[grepl("1st", UniqMetrics, fixed = TRUE) 
                    | grepl("first", UniqMetrics, fixed = TRUE)
                    ]
second = UniqMetrics[grepl("2nd", UniqMetrics, fixed = TRUE) 
                     | grepl("second", UniqMetrics, fixed = TRUE) 
                     ]
third = UniqMetrics[grepl("third", UniqMetrics, fixed = TRUE) 
                     | grepl("booster", UniqMetrics, fixed = TRUE) 
                     ]
```

* Build zero-matrix, which dimension is the count of metrics x the count of area types

```{r DatasetsMatrixM, include=FALSE}
M = matrix(0, length(UniqMetrics), length(keys(AreaTypesDict)))
rownames(M) = UniqMetrics
colnames(M) = keys(AreaTypesDict)
```

* Show links

```{r DatasetsMatrixMLinks, include=FALSE}
for(AreaType in keys(AreaTypesDict)){
M = show_links(M, AreaType)
}
```

* Look at the result

```{r DatasetsMatrixMView, echo=FALSE}
M %>%
  kable(booktabs = TRUE) %>%
  kable_styling(latex_options = "HOLD_position") %>%
  column_spec(1, width = "20em") %>%
  row_spec(which(UniqMetrics %in% first), color = "#104e8b", background = "#d3d3d3") %>%
  row_spec(which(UniqMetrics %in% second), color = "red", background = "#d3d3d3") %>%
  row_spec(which(UniqMetrics %in% third), color = "black", background = "#d3d3d3")
```

First of all, I am interested in data about the **first jab**.
**So, I need to look at the datasets:**

```{r DatasetsFirst, echo=FALSE}
FirstDataset <- c()

for(AreaType in keys(AreaTypesDict)){
  for(row in first) {
    if(M[row,AreaType] == 1){FirstDataset=append(FirstDataset,AreaTypesDict[[AreaType]])}
  }
}

my_kable(unique(FirstDataset))
```